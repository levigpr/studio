
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is a therapist
    function isTherapist(userId) {
      return get(/databases/$(database)/documents/usuarios/$(userId)).data.rol == 'terapeuta';
    }

    // Helper function to check if a user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Rules for 'usuarios' collection
    match /usuarios/{userId} {
      // Allow user to create their own profile
      allow create: if isOwner(userId);
      
      // Allow user to read their own profile. Allow therapists to read any profile.
      allow read: if isOwner(userId) || isTherapist(request.auth.uid);

      // Allow user to update their own profile
      allow update: if isOwner(userId);

      // Generally, don't allow users to delete their own account from the client
      allow delete: if false;
    }

    // Rules for 'expedientes' collection
    match /expedientes/{expedienteId} {
      // Allow read if user is the assigned patient or the assigned therapist
      allow read: if resource.data.pacienteUid == request.auth.uid || resource.data.terapeutaUid == request.auth.uid;
      
      // Allow create/update if the user is a therapist and is the one creating the record
      allow create, update: if isTherapist(request.auth.uid) && request.resource.data.terapeutaUid == request.auth.uid;
      
      // Allow delete if user is the assigned therapist
      allow delete: if isTherapist(request.auth.uid) && resource.data.terapeutaUid == request.auth.uid;
    }

    // Rules for 'sesiones' collection
    match /sesiones/{sesionId} {
       // Allow read if user is the assigned patient or the assigned therapist
      allow read: if resource.data.pacienteUid == request.auth.uid || resource.data.terapeutaUid == request.auth.uid;

      // Allow create/update if the user is a therapist and is assigned to the session
      allow create, update: if isTherapist(request.auth.uid) && request.resource.data.terapeutaUid == request.auth.uid;

      // Allow delete if user is the assigned therapist
      allow delete: if isTherapis(request.auth.uid) && resource.data.terapeutaUid == request.auth.uid;
    }

    // Rules for 'galerias' collection
    match /galerias/{galeriaId} {
      // Allow read if the gallery was created by the therapist or if the patient is assigned to it
      allow read: if resource.data.creadaPor == request.auth.uid || request.auth.uid in resource.data.pacientesAsignados;
      
      // Allow create/update/delete if the user is a therapist and the creator of the gallery
      allow create, update, delete: if isTherapist(request.auth.uid) && resource.data.creadaPor == request.auth.uid;
    }
  }
}
