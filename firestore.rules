
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función para verificar si el usuario autenticado tiene el rol de 'terapeuta'
    // Se basa en los custom claims del token de autenticación.
    function isTherapist() {
      return request.auth.token.rol == 'terapeuta';
    }

    // Perfiles de usuario:
    // - Los terapeutas pueden leer cualquier perfil.
    // - Los usuarios pueden leer, crear y actualizar su propio perfil.
    match /usuarios/{userId} {
      allow read: if isTherapist() || request.auth.uid == userId;
      allow create, update: if request.auth.uid == userId;
    }

    // Expedientes:
    // - Solo los terapeutas pueden leer, listar, crear y actualizar expedientes.
    match /expedientes/{expedienteId} {
      allow read, create, update: if isTherapist();
    }
    
    // Sesiones:
    // - Los terapeutas pueden leer y listar todas las sesiones.
    // - Los pacientes solo pueden leer y listar las sesiones que les pertenecen.
    // - Solo los terapeutas pueden crear, actualizar o borrar sesiones.
    match /sesiones/{sesionId} {
        allow list: if isTherapist() || (request.query.where.pacienteUid == request.auth.uid);
        allow read: if isTherapist() || request.auth.uid == resource.data.pacienteUid;
        allow create, update, delete: if isTherapist();
    }

    // Avances del paciente:
    // - Los terapeutas pueden leer y listar todos los avances.
    // - Los pacientes solo pueden leer y listar sus propios avances.
    // - Cualquier usuario autenticado puede crear un avance (el paciente lo crea para sí mismo).
    match /avances/{avanceId} {
        allow list: if isTherapist() || (request.query.where.pacienteUid == request.auth.uid);
        allow read: if isTherapist() || request.auth.uid == resource.data.pacienteUid;
        allow create: if request.auth.uid != null;
    }

    // Galerías de videos:
    // - Cualquier usuario autenticado puede leer/listar galerías.
    // - Solo los terapeutas pueden crear y actualizar galerías.
    match /galerias/{galeriaId} {
      allow read, list: if request.auth.uid != null;
      allow create, update: if isTherapist();
    }
  }
}
