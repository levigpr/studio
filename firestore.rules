rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /usuarios/{userId} {
      // Create: Anyone can create a user profile (signup)
      allow create: if request.auth.uid == userId;
      // Read: Authenticated users can read their own profile, therapists can read patient profiles.
      allow read: if request.auth.uid == userId || (get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'terapeuta');
      // Update: Authenticated users can update their own profile
      allow update: if request.auth.uid == userId;
      // List: Therapists can list patients, but this is a broad rule.
      // We will handle specific patient listing in the app logic.
      // Deny general listing for security.
      allow list: if get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'terapeuta';
    }

    match /expedientes/{expedienteId} {
      // Read: The assigned therapist or patient can read the record.
      allow read: if request.auth.uid == resource.data.terapeutaUid || request.auth.uid == resource.data.pacienteUid;

      // Create: Only an authenticated therapist can create a record for a patient.
      // Fields diagnostico, objetivos, and planTratamiento are optional on creation.
      allow create: if request.auth.uid != null
                    && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'terapeuta'
                    && request.resource.data.terapeutaUid == request.auth.uid
                    && 'pacienteUid' in request.resource.data
                    && 'fechaCreacion' in request.resource.data;
      
      // Update: Only the assigned therapist can update the clinical information.
      allow update: if request.auth.uid == resource.data.terapeutaUid;

      // List: Therapists can list the records that belong to them.
      allow list: if request.auth.uid != null && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'terapeuta';

      // Delete: Not allowed for now to prevent accidental data loss.
      allow delete: if false;
    }

    match /sesiones/{sesionId} {
      // Read, List: The assigned therapist or patient can read/list sessions.
      allow read, list: if request.auth.uid == resource.data.terapeutaUid 
                  || request.auth.uid == resource.data.pacienteUid
                  || (get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'terapeuta' && request.query.get('terapeutaUid') == request.auth.uid);

      // Create: The assigned therapist can create sessions.
      allow create: if request.auth.uid != null
                    && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'terapeuta'
                    && request.resource.data.terapeutaUid == request.auth.uid;
      
      // Update: The assigned therapist can update sessions (e.g., mark as complete).
      allow update: if request.auth.uid == resource.data.terapeutaUid;
    }

    match /galerias/{galeriaId} {
      // Read: The creator (therapist) or an assigned patient can read.
      allow read: if request.auth.uid == resource.data.creadaPor || request.auth.uid in resource.data.pacientesAsignados;
      
      // List: Therapists can list their own galleries. Patients can list galleries assigned to them.
      allow list: if (get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'terapeuta' && request.query.get('creadaPor') == request.auth.uid)
                  || (get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'paciente' && request.auth.uid in resource.data.pacientesAsignados);

      // Create: Only therapists can create galleries.
      allow create: if get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'terapeuta';
      
      // Update: Only the creator (therapist) can update.
      allow update: if request.auth.uid == resource.data.creadaPor;
    }

    match /avances/{avanceId} {
        // Read, List: The assigned therapist or patient can read/list their progress reports.
        allow read, list: if request.auth.uid == resource.data.terapeutaUid 
                    || request.auth.uid == resource.data.pacienteUid
                    || (get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'terapeuta' && request.query.get('terapeutaUid') == request.auth.uid);

        // Create: Only patients can create self-reports.
        allow create: if get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'paciente'
                      && request.resource.data.pacienteUid == request.auth.uid;
    }
  }
}
