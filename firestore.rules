rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Reglas para la colección 'usuarios'
    match /usuarios/{userId} {
      // Cualquiera puede crear un perfil de usuario (signup)
      allow create: if request.auth != null;

      // Un usuario solo puede leer o actualizar su propio perfil
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }

    // Reglas para la colección 'expedientes'
    match /expedientes/{expedienteId} {
        // Quién puede leer:
        // - El terapeuta asignado al expediente.
        // - El paciente asignado al expediente.
        allow read: if request.auth != null && (request.auth.uid == resource.data.terapeutaUid || request.auth.uid == resource.data.pacienteUid);

        // Quién puede listar (hacer queries):
        // - El terapeuta para ver sus propios expedientes.
        allow list: if request.auth != null && request.query.get("where")[0][0] == "terapeutaUid" && request.query.get("where")[0][2] == request.auth.uid;

        // Quién puede crear:
        // - Un terapeuta autenticado.
        // - Se deben incluir los campos obligatorios.
        allow create: if request.auth != null && request.resource.data.terapeutaUid == request.auth.uid
                        && 'pacienteUid' in request.resource.data && request.resource.data.pacienteUid is string
                        && 'diagnostico' in request.resource.data && request.resource.data.diagnostico is string
                        && 'objetivos' in request.resource.data && request.resource.data.objetivos is string
                        && 'planTratamiento' in request.resource.data && request.resource.data.planTratamiento is string
                        && 'fechaCreacion' in request.resource.data;
    }

    // Reglas para la colección 'galerias'
    match /galerias/{galeriaId} {
        // Quién puede leer:
        // - El terapeuta que la creó.
        // - Los pacientes que están en la lista de 'pacientesAsignados'.
        allow read: if request.auth != null && (request.auth.uid == resource.data.creadaPor || request.auth.uid in resource.data.pacientesAsignados);

        // Quién puede listar:
        // - Terapeutas para ver sus galerías.
        // - Pacientes para ver las galerías asignadas a ellos.
        allow list: if request.auth != null &&
                    ((request.query.get("where")[0][0] == "creadaPor" && request.query.get("where")[0][2] == request.auth.uid) ||
                     (request.query.get("where")[0][0] == "pacientesAsignados" && request.query.get("where")[0][1] == "array-contains" && request.query.get("where")[0][2] == request.auth.uid));

        // Quién puede crear o actualizar:
        // - Solo el terapeuta que la creó.
        allow create, update: if request.auth != null && request.resource.data.creadaPor == request.auth.uid;
    }

    // Reglas para la colección 'sesiones'
    match /sesiones/{sesionId} {
        // Quién puede leer o listar:
        // - El terapeuta asignado a la sesión.
        // - El paciente asignado a la sesión.
        allow read, list: if request.auth != null && (
            (request.query.get("where")[0][0] == "pacienteUid" && request.query.get("where")[0][2] == request.auth.uid) ||
            (request.query.get("where")[0][0] == "terapeutaUid" && request.query.get("where")[0][2] == request.auth.uid) ||
            (request.auth.uid == resource.data.terapeutaUid) ||
            (request.auth.uid == resource.data.pacienteUid)
        );

        // Quién puede crear:
        // - Solo el terapeuta asignado al expediente.
        allow create: if request.auth != null && request.resource.data.terapeutaUid == request.auth.uid;

        // Quién puede actualizar:
        // - Solo el terapeuta asignado a la sesión.
        allow update: if request.auth != null && request.auth.uid == resource.data.terapeutaUid;
    }

    // Reglas para la colección 'avances'
    match /avances/{avanceId} {
        // Quién puede leer o listar:
        // - El terapeuta o el paciente asignados al avance.
        allow read, list: if request.auth != null && (
            (request.query.get("where")[0][0] == "pacienteUid" && request.query.get("where")[0][2] == request.auth.uid) ||
            (request.query.get("where")[0][0] == "terapeutaUid" && request.query.get("where")[0][2] == request.auth.uid) ||
            (request.auth.uid == resource.data.terapeutaUid) ||
            (request.auth.uid == resource.data.pacienteUid)
        );

        // Quién puede crear:
        // - El paciente que está registrando su propio avance.
        allow create: if request.auth != null && request.resource.data.pacienteUid == request.auth.uid;
    }
  }
}
