rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is a therapist
    function isTherapist(userId) {
      return get(/databases/$(database)/documents/usuarios/$(userId)).data.rol == 'terapeuta';
    }
    
    // Helper function to check if a user is the owner
    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    // Reglas para la colección 'usuarios' (perfiles)
    match /usuarios/{userId} {
      // Cualquier terapeuta puede ver el perfil de cualquier paciente.
      // Un paciente solo puede ver su propio perfil.
      allow get: if isTherapist(request.auth.uid) || isOwner(userId);
      
      // Solo los terapeutas pueden listar a los pacientes.
      allow list: if isTherapist(request.auth.uid);
      
      // Cualquiera puede crear un perfil (signup).
      // Solo el dueño o un terapeuta puede actualizar un perfil.
      allow create: if request.auth.uid != null;
      allow update: if isOwner(userId) || isTherapist(request.auth.uid);
    }
    
    // Reglas para la colección 'expedientes'
    match /expedientes/{expedienteId} {
        // Cualquier terapeuta puede leer, crear, y actualizar cualquier expediente.
        allow read, create, update: if isTherapist(request.auth.uid);
        
        // Un paciente solo puede leer el expediente si su UID coincide.
        allow get: if request.auth.uid == resource.data.pacienteUid;
    }

    // Reglas para la colección 'sesiones'
    match /sesiones/{sesionId} {
        // Cualquier terapeuta puede leer y modificar cualquier sesión.
        allow read, write: if isTherapist(request.auth.uid);
        
        // Un paciente solo puede leer las sesiones donde su UID coincide.
        allow get, list: if request.auth.uid == resource.data.pacienteUid || (exists(/databases/$(database)/documents/sesiones/$(sesionId)) && get(/databases/$(database)/documents/sesiones/$(sesionId)).data.pacienteUid == request.auth.uid);
    }

    // Reglas para la colección 'avances'
    match /avances/{avanceId} {
        // Un paciente puede crear su propio avance.
        allow create: if request.auth.uid == request.resource.data.pacienteUid;

        // Cualquier terapeuta puede leer cualquier avance.
        allow read: if isTherapist(request.auth.uid);
        
        // Un paciente solo puede leer los avances donde su UID coincide.
        allow get, list: if request.auth.uid == resource.data.pacienteUid || (exists(/databases/$(database)/documents/avances/$(avanceId)) && get(/databases/$(database)/documents/avances/$(avanceId)).data.pacienteUid == request.auth.uid);
    }

    // Reglas para la colección 'galerias'
    match /galerias/{galeriaId} {
        // Solo los terapeutas pueden crear, leer y actualizar galerías.
        allow read, write: if isTherapist(request.auth.uid);
        
        // Un paciente puede leer una galería si su UID está en la lista de 'pacientesAsignados'.
        allow get: if request.auth.uid in resource.data.pacientesAsignados;
        allow list: if request.query.where.pacientesAsignados.includes(request.auth.uid);
    }
  }
}
